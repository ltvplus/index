<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reproductor M3U</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background-color: #000;
      overflow: hidden;
    }

    #video-container {
      position: relative;
      width: 100%;
      height: 100%;
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background-color: black;
      border: none;
    }

    /* Estilo para el botón de play */
    #play-button {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      font-size: 50px;
      padding: 20px;
      border-radius: 50%;
      cursor: pointer;
      z-index: 10;
    }

    #overlay {
      position: absolute;
      top: 20px;
      left: 20px;
      background-color: rgba(0, 0, 0, 0.8);
      color: white;
      font-size: 30px;
      padding: 15px 25px;
      border-radius: 8px;
      z-index: 10;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.5s ease, transform 0.5s ease;
    }

    #overlay.show {
      opacity: 1;
      transform: translateY(10px);
    }
  </style>
</head>
<body>
  <div id="video-container">
    <!-- Video player sin controles -->
    <video id="video-player" autoplay playsinline></video>
    <!-- Botón de Play personalizado -->
    <div id="play-button">▶️</div>
    <div id="overlay"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
    const videoPlayer = document.getElementById("video-player");
    const overlay = document.getElementById("overlay");
    const playButton = document.getElementById("play-button");

    let listaCanales = [];
    let canalActual = 0;
    let canalTemporal = "";
    let tiempoEntrada = null;
    let hls = null;

    const urlM3U = "https://raw.githubusercontent.com/rojasrony12/server/refs/heads/main/cabletv.m3u";

    // Cargar lista de canales desde el archivo M3U
    async function cargarLista() {
      try {
        const response = await fetch(urlM3U, { mode: "cors" });
        const data = await response.text();
        const lineas = data.split("\n");
        listaCanales = [];

        for (let i = 0; i < lineas.length; i++) {
          let linea = lineas[i].trim();
          if (linea.startsWith("#EXTINF")) {
            const nombre = linea.split(",")[1] || "Desconocido";
            const urlVideo = lineas[i + 1]?.trim() || "";
            if (urlVideo && /\.(m3u8|m3u)$/.test(urlVideo)) {
              listaCanales.push({ nombre, urlVideo });
            }
          }
        }

        // Recuperar el canal guardado desde localStorage
        const canalGuardado = localStorage.getItem("canalActual");
        if (canalGuardado && canalGuardado >= 0 && canalGuardado < listaCanales.length) {
          canalActual = parseInt(canalGuardado, 10);
        }

        if (listaCanales.length > 0) {
          playVideo(listaCanales[canalActual].urlVideo);
        }
      } catch (error) {
        console.error("Error al cargar la lista M3U:", error);
        alert("No se pudo cargar la lista. Verifica la URL.");
      }
    }

    // Reproducir el video del canal seleccionado
    function playVideo(url) {
      if (hls) {
        hls.destroy();
        hls = null;
      }

      videoPlayer.pause();
      videoPlayer.src = "";
      videoPlayer.load();

      if (url.endsWith(".m3u8")) {
        if (Hls.isSupported()) {
          hls = new Hls();
          hls.loadSource(url);
          hls.attachMedia(videoPlayer);
          hls.on(Hls.Events.MANIFEST_PARSED, function () {
            videoPlayer.play().catch((e) => console.warn("Autoplay fallido:", e));
          });
        } else if (videoPlayer.canPlayType("application/vnd.apple.mpegurl")) {
          videoPlayer.src = url;
          videoPlayer.addEventListener("loadedmetadata", () => {
            videoPlayer.play().catch((e) => console.warn("Autoplay fallido:", e));
          });
        } else {
          alert("Tu navegador no soporta streams HLS.");
        }
      } else {
        videoPlayer.src = url;
        videoPlayer.play().catch((e) => console.warn("Error al reproducir:", e));
      }

      // Ocultar el botón de play y mostrar overlay
      playButton.style.display = 'none';
      mostrarOverlay(canalActual + 1, listaCanales[canalActual].nombre);
    }

    // Mostrar el overlay con el número de canal y el nombre
    function mostrarOverlay(numero, nombre) {
      overlay.textContent = `${numero} - ${nombre}`;
      overlay.classList.add("show");
      setTimeout(() => overlay.classList.remove("show"), 3000);
    }

    // Cambiar de canal y guardar el canal actual
    function cambiarCanal(nuevoIndice) {
      if (nuevoIndice < 0) {
        canalActual = listaCanales.length - 1;
      } else if (nuevoIndice >= listaCanales.length) {
        canalActual = 0;
      } else {
        canalActual = nuevoIndice;
      }

      playVideo(listaCanales[canalActual].urlVideo);

      // Guardar el canal actual en localStorage
      localStorage.setItem("canalActual", canalActual);
    }

    // Event listener para el botón de play
    playButton.addEventListener('click', function() {
      playButton.style.display = 'none'; // Ocultar el botón de play
      playVideo(listaCanales[canalActual].urlVideo); // Reproducir video al hacer click
    });

    document.addEventListener('keydown', function(event) {
      if (event.key === "ArrowUp") {
        cambiarCanal(canalActual + 1); // 🔼 Subir al canal siguiente
      } else if (event.key === "ArrowDown") {
        cambiarCanal(canalActual - 1); // 🔽 Bajar al canal anterior
      }

      const numero = event.key;
      if (numero >= '0' && numero <= '9') {
        canalTemporal += numero;
        clearTimeout(tiempoEntrada);
        tiempoEntrada = setTimeout(() => {
          const canalNumero = parseInt(canalTemporal, 10);
          if (canalNumero >= 1 && canalNumero <= listaCanales.length) {
            canalActual = canalNumero - 1;
            playVideo(listaCanales[canalActual].urlVideo);
            localStorage.setItem("canalActual", canalActual); // Guardar canal seleccionado
          }
          canalTemporal = "";
        }, 2000);
      }
    });

    cargarLista();
  </script>
</body>
</html>
