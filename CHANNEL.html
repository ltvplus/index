<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="apple-mobile-web-app-capable" content="no" />
  <meta name="mobile-web-app-capable" content="no" />
  <title>Reproductor M3U</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background-color: #000;
      overflow: hidden;
      color: white;
    }

    .fullscreen-video {
      position: relative;
      width: 100%;
      height: 100%;
      background-color: black;
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background-color: black;
      border: none;
    }

    #overlay {
      position: absolute;
      top: 20px;
      left: 20px;
      background-color: rgba(0, 0, 0, 0.8);
      color: white;
      font-size: 30px;
      padding: 15px 25px;
      border-radius: 8px;
      z-index: 10;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.5s ease, transform 0.5s ease;
    }

    #overlay.show {
      opacity: 1;
      transform: translateY(10px);
    }
  </style>
</head>
<body>
  <div id="fullscreen-video" class="fullscreen-video">
    <video id="video-player" autoplay muted controls></video>
    <div id="overlay"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
    const videoPlayer = document.getElementById("video-player");
    const overlay = document.getElementById("overlay");

    let listaCanales = [];
    let canalActual = 0;
    let canalTemporal = "";
    let tiempoEntrada = null;

    const urlM3U = "https://raw.githubusercontent.com/rojasrony12/server/refs/heads/main/cabletv.m3u";

    async function cargarLista() {
      try {
        const response = await fetch(urlM3U, { mode: "cors" });
        const data = await response.text();
        const lineas = data.split("\n");
        listaCanales = [];

        for (let i = 0; i < lineas.length; i++) {
          const linea = lineas[i].trim();
          if (linea.startsWith("#EXTINF")) {
            const nombre = linea.split(",")[1] || "Desconocido";
            const urlVideo = lineas[i + 1]?.trim() || "";
            if (urlVideo && /\.(m3u8|m3u)$/.test(urlVideo)) {
              listaCanales.push({ nombre, urlVideo });
            }
          }
        }

        const canalGuardado = localStorage.getItem("canalActual");
        if (canalGuardado && canalGuardado >= 0 && canalGuardado < listaCanales.length) {
          canalActual = parseInt(canalGuardado, 10);
        }

        if (listaCanales.length > 0) {
          playVideo(listaCanales[canalActual].urlVideo);
        }
      } catch (error) {
        console.error("Error al cargar la lista M3U:", error);
        alert("No se pudo cargar la lista. Verifica la URL.");
      }
    }

    function playVideo(url) {
      videoPlayer.onerror = null;
      videoPlayer.pause();
      videoPlayer.src = "";

      if (url.endsWith(".m3u8")) {
        if (Hls.isSupported()) {
          const hls = new Hls();
          hls.loadSource(url);
          hls.attachMedia(videoPlayer);
          hls.on(Hls.Events.MANIFEST_PARSED, function () {
            videoPlayer.play();
          });
        } else {
          alert("Tu navegador no soporta HLS.js.");
        }
      } else {
        videoPlayer.src = url;
        videoPlayer.play();
      }

      videoPlayer.muted = false;
      videoPlayer.onerror = () => {
        if (videoPlayer.src) {
          alert("Este canal no se puede reproducir en este momento.");
        }
      };

      mostrarOverlay(canalActual + 1, listaCanales[canalActual].nombre);
    }

    function mostrarOverlay(numero, nombre) {
      overlay.textContent = `${numero} - ${nombre}`;
      overlay.classList.add("show");
      setTimeout(() => overlay.classList.remove("show"), 3000);
    }

    function cambiarCanal(nuevoIndice) {
      if (nuevoIndice < 0) {
        canalActual = listaCanales.length - 1;
      } else if (nuevoIndice >= listaCanales.length) {
        canalActual = 0;
      } else {
        canalActual = nuevoIndice;
      }

      playVideo(listaCanales[canalActual].urlVideo);
      localStorage.setItem("canalActual", canalActual);
    }

    document.addEventListener('keydown', function (event) {
      if (event.key === "ArrowUp") {
        cambiarCanal(canalActual + 1);
      } else if (event.key === "ArrowDown") {
        cambiarCanal(canalActual - 1);
      }

      const numero = event.key;
      if (numero >= '0' && numero <= '9') {
        canalTemporal += numero;
        clearTimeout(tiempoEntrada);
        tiempoEntrada = setTimeout(() => {
          const canalNumero = parseInt(canalTemporal, 10);
          if (canalNumero >= 1 && canalNumero <= listaCanales.length) {
            canalActual = canalNumero - 1;
            playVideo(listaCanales[canalActual].urlVideo);
            localStorage.setItem("canalActual", canalActual);
          }
          canalTemporal = "";
        }, 2000);
      }
    });

    cargarLista();
  </script>
</body>
</html>
