<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reproductor M3U</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background-color: #141414;
      color: #ffffff;
      user-select: none; /* Deshabilitar selección de texto */
    }
    #search-container {
      margin: 20px;
    }
    #search-bar {
      width: 100%;
      max-width: 500px;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #444;
      background-color: #1e1e1e;
      color: white;
      font-size: 16px;
    }
    #lista {
      max-width: 90%;
      margin: 20px auto;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
      justify-content: center;
    }
    .item {
      cursor: pointer;
      border: 1px solid #444;
      padding: 10px;
      background: #1e1e1e;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: transform 0.2s;
      outline: none;
    }
    .item:hover,
    .item:focus {
      transform: scale(1.05);
      border-color: #e50914;
    }
    .item img {
      width: 100%;
      height: auto;
      object-fit: cover;
      border-radius: 5px;
    }
    .item span {
      margin-top: 5px;
      font-size: 14px;
      text-align: center;
    }
    .fullscreen-video {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: black;
      z-index: 9999;
      overflow: hidden;
    }
    .fullscreen-video video {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
  </style>
</head>
<body>
  <div id="search-container">
    <input
      id="search-bar"
      type="text"
      placeholder="Buscar por nombre de canal o video..."
      oninput="filtrarLista()"
    />
  </div>
  <div id="lista"></div>

  <div id="fullscreen-video" class="fullscreen-video">
    <video id="video-player" controls autoplay></video>
  </div>

  <!-- hls.js para reproducir .m3u8 -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

  <script>
    let videoPlayer = document.getElementById("video-player");
    let fullscreenVideo = document.getElementById("fullscreen-video");
    let listaElementos = document.getElementById("lista");
    let listaCanales = [];

    // Deshabilitar clic derecho y otras acciones
    document.addEventListener('contextmenu', function(e) {
      e.preventDefault();
    });

    // Bloqueo de teclas como Ctrl + U, F12, etc.
    document.addEventListener('keydown', function(e) {
      if (e.key === 'F12') e.preventDefault();
      if ((e.ctrlKey && e.key === 'u') || (e.ctrlKey && e.key === 'U')) e.preventDefault();
      if ((e.ctrlKey && e.shiftKey && e.key === 'I') || (e.ctrlKey && e.shiftKey && e.key === 'i')) e.preventDefault();
      if (e.key === 'F5') e.preventDefault();
    });

    function playVideo(url) {
      fullscreenVideo.style.display = "block";

      // Limpiar errores anteriores
      videoPlayer.onerror = null;

      if (Hls.isSupported() && url.endsWith(".m3u8")) {
        const hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(videoPlayer);
        hls.on(Hls.Events.MANIFEST_PARSED, function () {
          videoPlayer.play();
        });
      } else if (videoPlayer.canPlayType("application/vnd.apple.mpegurl") && url.endsWith(".m3u8")) {
        videoPlayer.src = url;
        videoPlayer.addEventListener("loadedmetadata", () =>
          videoPlayer.play()
        );
      } else {
        // Reproducir directamente otros tipos de archivos (mp4, webm, etc.)
        videoPlayer.src = url;
        videoPlayer.play();
      }

      // Mostrar error real si el video falla al cargar
      videoPlayer.onerror = function () {
        if (videoPlayer.src) {
          alert("Este formato de video no es compatible con tu navegador.");
        }
      };

      // Intentar poner el video en pantalla completa
      if (fullscreenVideo.requestFullscreen) {
        fullscreenVideo.requestFullscreen();
      } else if (fullscreenVideo.webkitRequestFullscreen) {
        fullscreenVideo.webkitRequestFullscreen();
      }

      history.pushState(null, "", "#fullscreen");

      // Guardar la posición de la pantalla antes de abrir el video
      localStorage.setItem("scrollPosition", window.scrollY);
    }

    window.onpopstate = function () {
      cerrarVideo();
    };

    document.addEventListener("fullscreenchange", exitFullscreen);
    document.addEventListener("webkitfullscreenchange", exitFullscreen);
    document.addEventListener("mozfullscreenchange", exitFullscreen);
    document.addEventListener("MSFullscreenChange", exitFullscreen);

    function exitFullscreen() {
      if (
        !document.fullscreenElement &&
        !document.webkitFullscreenElement &&
        !document.mozFullScreenElement &&
        !document.msFullscreenElement
      ) {
        cerrarVideo();
      }
    }

    function cerrarVideo() {
      fullscreenVideo.style.display = "none";
      videoPlayer.pause();
      videoPlayer.removeAttribute("src");
      videoPlayer.load();
      videoPlayer.onerror = null;

      // Restaurar la posición de la página
      const scrollPosition = localStorage.getItem("scrollPosition");
      if (scrollPosition) {
        window.scrollTo(0, scrollPosition);
        localStorage.removeItem("scrollPosition"); // Limpiar la posición después de usarla
      }
    }

    async function cargarLista() {
      const url = "https://raw.githubusercontent.com/rojasrony12/server/refs/heads/main/c4bl3.m3u";

      try {
        const response = await fetch(url, { mode: "cors" });
        if (!response.ok)
          throw new Error(`HTTP error! Status: ${response.status}`);

        const data = await response.text();
        const lineas = data.split("\n");
        listaCanales = [];
        listaElementos.innerHTML = "";

        for (let i = 0; i < lineas.length; i++) {
          let linea = lineas[i].trim();
          if (linea.startsWith("#EXTINF")) {
            const datos = linea.split(",");
            const nombre = datos.length > 1 ? datos[1] : "Desconocido";
            const logoMatch = linea.match(/tvg-logo="(.*?)"/);
            const logo = logoMatch ? logoMatch[1] : "";

            let urlVideo =
              lineas[i + 1] && lineas[i + 1].trim().length > 0
                ? lineas[i + 1].trim()
                : "";
            if (
              urlVideo &&
              (urlVideo.endsWith(".mp4") ||
                urlVideo.endsWith(".webm") ||
                urlVideo.endsWith(".ogg") ||
                urlVideo.endsWith(".m3u8") ||
                urlVideo.endsWith(".m3u"))
            ) {
              const item = document.createElement("div");
              item.classList.add("item");
              item.tabIndex = 0;

              if (logo) {
                const img = document.createElement("img");
                img.src = logo;
                img.alt = nombre;
                item.appendChild(img);
              }

              const texto = document.createElement("span");
              texto.textContent = nombre;
              item.appendChild(texto);

              item.onclick = function () {
                playVideo(urlVideo);
              };

              listaCanales.push({ nombre, item, urlVideo });
              listaElementos.appendChild(item);
            }
          }
        }
      } catch (error) {
        console.error("Error al cargar la lista M3U:", error);
        alert("No se pudo cargar la lista. Verifica la URL e intenta de nuevo.");
      }
    }

    function filtrarLista() {
      const filtro = document.getElementById("search-bar").value.toLowerCase();

      listaCanales.forEach((canal) => {
        const nombreCanal = canal.nombre.toLowerCase();
        canal.item.style.display = nombreCanal.includes(filtro) ? "" : "none";
      });
    }

    window.onload = function () {
      cargarLista();
    };

    document.addEventListener("keydown", function (e) {
      switch (e.key) {
        case "ArrowUp":
          videoPlayer.volume = Math.min(1, videoPlayer.volume + 0.1);
          break;
        case "ArrowDown":
          videoPlayer.volume = Math.max(0, videoPlayer.volume - 0.1);
          break;
        case "ArrowLeft":
          videoPlayer.currentTime -= 10;
          break;
        case "ArrowRight":
          videoPlayer.currentTime += 10;
          break;
        case "Enter":
          if (videoPlayer.paused) {
            videoPlayer.play();
          } else {
            videoPlayer.pause();
          }
          break;
        case "Backspace":
          cerrarVideo();
          break;
      }
    });
  </script>
</body>
</html>
